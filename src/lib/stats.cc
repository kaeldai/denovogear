/*
 * Copyright (c) 2015 Reed A. Cartwright
 * Authors:  Reed A. Cartwright <reed@cartwrig.ht>
 *
 * This file is part of DeNovoGear.
 *
 * DeNovoGear is free software: you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; either version 3 of the License, or (at your option) any later
 * version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * this program. If not, see <http://www.gnu.org/licenses/>.
 */

#include <dng/stats.h>

#include <boost/math/distributions/chi_squared.hpp>
#include <boost/math/distributions/complement.hpp>

#include <boost/range/algorithm/sort.hpp>
#include <boost/range/algorithm/merge.hpp>
#include <boost/range/algorithm/adjacent_find.hpp>

constexpr double log_factorial[1024] = {
    0, 0, 0.69314718055994529, 1.791759469228055,
    3.1780538303479458, 4.7874917427820458, 6.5792512120101012, 8.5251613610654147,
    10.604602902745251, 12.801827480081469, 15.104412573075519, 17.50230784587389,
    19.987214495661885, 22.552163853123421, 25.191221182738683, 27.899271383840894,
    30.671860106080675, 33.505073450136891, 36.395445208033053, 39.339884187199495,
    42.335616460753485, 45.380138898476901, 48.47118135183522, 51.60667556776437,
    54.784729398112312, 58.003605222980511, 61.261701761001994, 64.557538627006323,
    67.88974313718154, 71.257038967168, 74.658236348830158, 78.092223553315307,
    81.557959456115029, 85.05446701758153, 88.580827542197667, 92.136175603687093,
    95.719694542143216, 99.330612454787413, 102.96819861451382, 106.63176026064346,
    110.32063971475741, 114.03421178146171, 117.77188139974507, 121.53308151543865,
    125.3172711493569, 129.12393363912724, 132.95257503561629, 136.80272263732638,
    140.67392364823425, 144.56574394634487, 148.47776695177302, 152.40959258449737,
    156.3608363030788, 160.33112821663093, 164.3201122631952, 168.32744544842768,
    172.35279713916282, 176.39584840699735, 180.45629141754378, 184.53382886144948,
    188.62817342367163, 192.73904728784493, 196.86618167288995, 201.00931639928149,
    205.16819948264117, 209.34258675253679, 213.53224149456324, 217.73693411395422,
    221.95644181913033, 226.1905483237276, 230.4390435657769, 234.70172344281823,
    238.97838956183432, 243.26884900298271, 247.57291409618682, 251.89040220972316,
    256.22113555000954, 260.56494097186322, 264.92164979855278, 269.29109765101975,
    273.67312428569375, 278.06757344036617, 282.47429268763045, 286.89313329542699,
    291.32395009427029, 295.7666013507606, 300.2209486470141, 304.68685676566872,
    309.1641935801469, 313.65282994987899, 318.1526396202093, 322.66349912672621,
    327.18528770377526, 331.71788719692847, 336.26118197919845, 340.81505887079896,
    345.37940706226686, 349.95411804077025, 354.53908551944079, 359.1342053695754,
    363.73937555556347, 368.35449607240469, 372.97946888568902, 377.61419787391861,
    382.25858877305996, 386.9125491232175, 391.57598821732955, 396.24881705179149,
    400.93094827891571, 405.62229616114496, 410.32277652693733, 415.03230672824964,
    419.75080559954483, 424.47819341825715, 429.21439186665162, 433.95932399501481,
    438.71291418612122, 443.475088120919, 448.24577274538467, 453.02489623849618,
    457.81238798127828, 462.60817852687495, 467.41219957160814, 472.22438392698069,
    477.04466549258575, 481.87297922988796, 486.70926113683942, 491.55344822329795,
    496.40547848721764, 501.2652908915793, 506.13282534203489, 511.00802266523601,
    515.89082458782252, 520.78117371604424, 525.67901351599517, 530.58428829443358,
    535.49694318016952, 540.41692410599774, 545.34417779115483, 550.27865172428551,
    555.22029414689496, 560.1690540372731, 565.12488109487424, 570.08772572513419,
    575.0575390247102, 580.0342727671308, 585.01787938883911, 590.00831197561786,
    595.00552424938201, 600.00947055532743, 605.02010584942377, 610.03738568623874,
    615.06126620708494, 620.09170412847743, 625.12865673089107, 630.1720818478102,
    635.22193785505965, 640.2781836604081, 645.34077869343503, 650.40968289565524,
    655.48485671088906, 660.56626107587351, 665.65385741110595, 670.74760761191271,
    675.84747403973688, 680.95341951363753, 686.06540730199413, 691.1834011144108,
    696.30736509381404, 701.43726380873716, 706.57306224578747, 711.71472580228999,
    716.86222027910355, 722.01551187360133, 727.17456717281584, 732.3393531467392,
    737.50983714177733, 742.68598687435122, 747.86777042464337, 753.05515623048416,
    758.24811308137441, 763.44661011264009, 768.65061679971711, 773.86010295255846,
    779.07503871016729, 784.2953945352458, 789.52114120895897, 794.75224982581346,
    799.98869178864345, 805.23043880370312, 810.47746287586358, 815.72973630391016,
    820.98723167593789, 826.24992186484292, 831.51778002390631, 836.7907795824699,
    842.06889424170049, 847.35209797043842, 852.64036500113286, 857.93366982585746,
    863.23198719240543, 868.53529210046463, 873.84355979786574, 879.1567657769076,
    884.47488577075183, 889.79789574989024, 895.12577191867967, 900.45849071194505,
    905.79602879164634, 911.13836304361121, 916.48547057432882, 921.83732870780489,
    927.19391498247694, 932.55520714818624, 937.92118316320807, 943.29182119133588,
    948.66709959902005, 954.04699695256045, 959.43149201534948, 964.82056374516617,
    970.21419129151832, 975.61235399303598, 981.0150313749084, 986.42220314636836,
    991.83384919822345, 997.24994960042807, 1002.6704845997003, 1008.0954346171817,
    1013.5247802461362, 1018.9585022496902, 1024.3965815586134, 1029.8389992691355,
    1035.2857366408014, 1040.7367750943674, 1046.1920962097249, 1051.6516817238694,
    1057.115513528895, 1062.5835736700301, 1068.0558443437014, 1073.5323078956328,
    1079.0129468189748, 1084.4977437524656, 1089.9866814786224, 1095.4797429219627,
    1100.9769111472563, 1106.4781693578007, 1111.983500893733, 1117.492889230361,
    1123.0063179765261, 1128.5237708729908, 1134.045231790853, 1139.5706847299848,
    1145.1001138174961, 1150.6335033062237, 1156.1708375732421, 1161.7121011184006,
    1167.2572785628804, 1172.8063546477754, 1178.359314232697, 1183.9161422943966,
    1189.4768239254124, 1195.0413443327348, 1200.6096888364959, 1206.1818428686736,
    1211.7577919718201, 1217.3375217978062, 1222.921018106588, 1228.5082667649881,
    1234.099253745499, 1239.6939651251009, 1245.2923870840991, 1250.894505904979,
    1256.5003079712751, 1262.10977976646, 1267.7229078728483, 1273.3396789705146,
    1278.9600798362317, 1284.584097342419, 1290.2117184561096, 1295.8429302379309,
    1301.4777198411002, 1307.1160745104341, 1312.7579815813722, 1318.4034284790155,
    1324.0524027171766, 1329.7048918974451, 1335.3608837082654, 1341.0203659240249,
    1346.6833264041607, 1352.3497530922732, 1358.0196340152536, 1363.6929572824251,
    1369.3697110846936, 1375.0498836937104, 1380.7334634610493, 1386.4204388173889,
    1392.1107982717131, 1397.8045304105158, 1403.5016238970211, 1409.2020674704117,
    1414.9058499450678, 1420.6129602098169, 1426.3233872271917, 1432.0371200327011,
    1437.7541477341076, 1443.4744595107147, 1449.198044612667, 1454.9248923602543,
    1460.6549921432281, 1466.3883334201257, 1472.1249057176046, 1477.8646986297842,
    1483.6077018175934, 1489.3539050081336, 1495.1032979940419, 1500.8558706328677,
    1506.6116128464544, 1512.370514620332, 1518.1325660031118, 1523.8977571058967,
    1529.6660781016906, 1535.4375192248208, 1541.212070770365, 1546.9897230935876,
    1552.77046660938, 1558.5542917917098, 1564.3411891730766, 1570.1311493439737,
    1575.9241629523578, 1581.7202207031232, 1587.5193133575838, 1593.3214317329607,
    1599.1265667018772, 1604.934709191858, 1610.7458501848344, 1616.5599807166595,
    1622.3770918766227, 1628.197174806975, 1634.0202207024581, 1639.8462208098385,
    1645.6751664274489, 1651.5070489047323, 1657.3418596417948, 1663.1795900889608,
    1669.0202317463345, 1674.8637761633656, 1680.7102149384234, 1686.5595397183702,
    1692.4117421981446, 1698.2668141203467, 1704.1247472748305, 1709.9855334982965,
    1715.8491646738944, 1721.7156327308276, 1727.5849296439617, 1733.4570474334371,
    1739.3319781642888, 1745.2097139460686, 1751.090246932469, 1756.9735693209577,
    1762.8596733524078, 1768.748551310741, 1774.6401955225663, 1780.5345983568311,
    1786.431752224468, 1792.3316495780502, 1798.2342829114518, 1804.1396447595066,
    1810.0477276976756, 1815.9585243417157, 1821.8720273473541, 1827.7882294099618,
    1833.7071232642347, 1839.6287016838787, 1845.5529574812929, 1851.4798835072636,
    1857.4094726506532, 1863.3417178381017, 1869.276612033721, 1875.2141482388035,
    1881.1543194915237, 1887.0971188666506, 1893.0425394752572, 1898.9905744644377,
    1904.9412170170256, 1910.8944603513132, 1916.8502977207781, 1922.8087224138078,
    1928.769727753431, 1934.7333070970499, 1940.6994538361732, 1946.6681613961587,
    1952.6394232359494, 1958.6132328478182, 1964.5895837571165, 1970.5684695220173,
    1976.5498837332718, 1982.533820013959, 1988.5202720192437, 1994.5092334361332,
    2000.5006979832413, 2006.4946594105481, 2012.4911114991667, 2018.4900480611136,
    2024.4914629390746, 2030.4953500061815, 2036.5017031657831, 2042.5105163512258,
    2048.5217835256303, 2054.5354986816728, 2060.5516558413706, 2066.5702490558674,
    2072.5912724052168, 2078.6147199981779, 2084.640585972003, 2090.6688644922338,
    2096.6995497524949, 2102.7326359742938, 2108.7681174068184, 2114.805988326741,
    2120.8462430380182, 2126.8888758717007, 2132.9338811857365, 2138.9812533647828,
    2145.0309868200152, 2151.0830759889391, 2157.1375153352087, 2163.1942993484372,
    2169.253422544019, 2175.3148794629469, 2181.3786646716344, 2187.4447727617385,
    2193.5131983499823, 2199.5839360779851, 2205.6569806120856, 2211.732326643174,
    2217.8099688865232, 2223.8899020816189, 2229.9721209919949, 2236.0566204050701,
    2242.1433951319827, 2248.2324400074294, 2254.3237498895073, 2260.417319659552,
    2266.5131442219845, 2272.6112185041511, 2278.7115374561708, 2284.814096050784,
    2290.9188892831999, 2297.0259121709419, 2303.1351597537064, 2309.2466270932086,
    2315.3603092730414, 2321.4762013985242, 2327.5942985965653, 2333.7145960155167,
    2339.8370888250306, 2345.9617722159251, 2352.0886414000393, 2358.2176916100993,
    2364.3489180995825, 2370.4823161425793, 2376.617881033661, 2382.7556080877471,
    2388.8954926399733, 2395.0375300455607, 2401.1817156796869, 2407.3280449373556,
    2413.4765132332732, 2419.6271160017195, 2425.7798486964239, 2431.9347067904396,
    2438.0916857760253, 2444.2507811645178, 2450.4119884862125, 2456.5753032902471,
    2462.7407211444788, 2468.9082376353672, 2475.0778483678582, 2481.2495489652697,
    2487.4233350691711, 2493.5992023392769, 2499.7771464533275, 2505.9571631069807,
    2512.1392480136969, 2518.3233969046346, 2524.5096055285348, 2530.6978696516176,
    2536.8881850574708, 2543.0805475469451, 2549.2749529380499, 2555.4713970658445,
    2561.6698757823369, 2567.8703849563794, 2574.0729204735676, 2580.2774782361362,
    2586.484054162861, 2592.6926441889577, 2598.9032442659823, 2605.1158503617339,
    2611.330458460156, 2617.5470645612409, 2623.7656646809328, 2629.9862548510323,
    2636.2088311191037, 2642.4333895483792, 2648.6599262176669, 2654.8884372212578,
    2661.1189186688362, 2667.3513666853864, 2673.585777411105, 2679.8221470013091,
    2686.0604716263483, 2692.3007474715191, 2698.5429707369744, 2704.7871376376379,
    2711.0332444031196, 2717.2812872776281, 2723.5312625198876, 2729.7831664030537,
    2736.0369952146289, 2742.2927452563822, 2748.5504128442653, 2754.8099943083294,
    2761.0714859926507, 2767.3348842552427, 2773.6001854679803, 2779.8673860165218,
    2786.1364823002277, 2792.407470732086, 2798.6803477386325, 2804.9551097598742,
    2811.2317532492157, 2817.5102746733819, 2823.7906705123419, 2830.0729372592377,
    2836.3570714203092, 2842.6430695148179, 2848.9309280749799, 2855.2206436458887,
    2861.5122127854465, 2867.8056320642931, 2874.100898065733, 2880.3980073856665,
    2886.6969566325224, 2892.9977424271856, 2899.3003614029308, 2905.6048102053533,
    2911.911085492301, 2918.2191839338102, 2924.5291022120368, 2930.8408370211896,
    2937.154385067467, 2943.4697430689889, 2949.7869077557366, 2956.105875869483,
    2962.4266441637337, 2968.7492094036606, 2975.0735683660419, 2981.3997178391974,
    2987.7276546229264, 2994.057375528449, 3000.3888773783433, 3006.722157006483,
    3013.0572112579807, 3019.394036989127, 3025.7326310673297, 3032.072990371058,
    3038.4151117897791, 3044.7589922239058, 3051.1046285847342, 3057.45201779439,
    3063.8011567857702, 3070.1520425024846, 3076.5046718988042, 3082.8590419396019,
    3089.2151496002975, 3095.5729918668058, 3101.9325657354784, 3108.2938682130507,
    3114.656896316591, 3121.0216470734435, 3127.3881175211745, 3133.756304707525,
    3140.1262056903533, 3146.497817537585, 3152.8711373271622, 3159.2461621469906,
    3165.6228890948892, 3172.00131527854, 3178.3814378154402, 3184.7632538328462,
    3191.1467604677305, 3197.5319548667285, 3203.9188341860909, 3210.3073955916366,
    3216.697636258702, 3223.0895533720941, 3229.4831441260449, 3235.8784057241605,
    3242.2753353793764, 3248.673930313912, 3255.0741877592209, 3261.4761049559479,
    3267.879679153883, 3274.2849076119132, 3280.691787597983, 3287.1003163890427,
    3293.5104912710085, 3299.9223095387183, 3306.335768495886, 3312.7508654550575,
    3319.1675977375698, 3325.5859626735059, 3332.0059576016529, 3338.4275798694594,
    3344.8508268329933, 3351.2756958568984, 3357.7021843143561, 3364.1302895870408,
    3370.5600090650801, 3376.991340147013, 3383.4242802397521, 3389.8588267585401,
    3396.2949771269091, 3402.7327287766457, 3409.172079147746, 3415.6130256883785,
    3422.0555658548474, 3428.4996971115479, 3434.9454169309324, 3441.3927227934746,
    3447.8416121876207, 3454.2920826097652, 3460.7441315642022, 3467.197756563095,
    3473.6529551264357, 3480.1097247820076, 3486.5680630653524, 3493.0279675197298,
    3499.4894356960835, 3505.9524651530041, 3512.4170534566942, 3518.8831981809317,
    3525.3508969070358, 3531.8201472238316, 3538.2909467276149, 3544.7632930221152,
    3551.2371837184678, 3557.7126164351721, 3564.1895887980609, 3570.6680984402706,
    3577.1481430021963, 3583.6297201314728, 3590.1128274829302, 3596.5974627185656,
    3603.0836235075094, 3609.5713075259941, 3616.0605124573199, 3622.5512359918221,
    3629.043475826842, 3635.5372296666942, 3642.032495222631, 3648.5292702128168,
    3655.0275523622936, 3661.5273394029496, 3668.0286290734894, 3674.5314191194047,
    3681.0357072929423, 3687.5414913530699, 3694.0487690654559, 3700.5575382024272,
    3707.06779654295, 3713.5795418725947, 3720.0927719835076, 3726.60748467438,
    3733.1236777504223, 3739.6413490233349, 3746.160496311275, 3752.6811174388336,
    3759.2032102370044, 3765.7267725431543, 3772.2518022009976, 3778.7782970605681,
    3785.3062549781907, 3791.8356738164521, 3798.3665514441786, 3804.8988857364011,
    3811.4326745743342, 3817.9679158453473, 3824.5046074429397, 3831.0427472667066,
    3837.5823332223249, 3844.1233632215144, 3850.6658351820211, 3857.2097470275858,
    3863.7550966879207, 3870.3018820986813, 3876.8501012014435, 3883.3997519436766,
    3889.950832278721, 3896.5033401657552, 3903.0572735697806, 3909.6126304615914,
    3916.1694088177496, 3922.7276066205623, 3929.2872218580551, 3935.8482525239515,
    3942.410696617646, 3948.9745521441782, 3955.5398171142124, 3962.1064895440159,
    3968.6745674554286, 3975.2440488758425, 3981.814931838182, 3988.3872143808758,
    3994.9608945478362, 4001.535970388436, 4008.1124399574851, 4014.6903013152059,
    4021.2695525272161, 4027.8501916645, 4034.4322168033937, 4041.0156260255521,
    4047.6004174179379, 4054.1865890727922, 4060.7741390876172, 4067.3630655651509,
    4073.953366613348, 4080.545040345356, 4087.1380848794988, 4093.7324983392482,
    4100.3282788532097, 4106.9254245550965, 4113.5239335837114, 4120.1238040829239,
    4126.7250342016523, 4133.3276220938424, 4139.9315659184431, 4146.5368638393902,
    4153.143514025588, 4159.7515146508849, 4166.3608638940523, 4172.97155993877,
    4179.5836009736031, 4186.1969851919821, 4192.8117107921871, 4199.4277759773204,
    4206.0451789552935, 4212.6639179388103, 4219.2839911453411, 4225.9053967971058,
    4232.5281331210563, 4239.1521983488556, 4245.7775907168634, 4252.4043084661134,
    4259.0323498422913, 4265.6617130957293, 4272.2923964813726, 4278.9243982587677,
    4285.5577166920484, 4292.1923500499097, 4298.8282966055958, 4305.4655546368804,
    4312.1041224260471, 4318.7439982598735, 4325.3851804296137, 4332.027667230981,
    4338.6714569641299, 4345.316547933634, 4351.9629384484824, 4358.6106268220465,
    4365.259611372071, 4371.9098904206576, 4378.5614622942476, 4385.2143253236018,
    4391.8684778437837, 4398.5239181941515, 4405.1806447183299, 4411.8386557642016,
    4418.4979496838851, 4425.1585248337242, 4431.8203795742693, 4438.4835122702607,
    4445.1479212906106, 4451.8136050083931, 4458.4805618008222, 4465.1487900492402,
    4471.8182881390976, 4478.4890544599439, 4485.1610874054049, 4491.8343853731731,
    4498.5089467649859, 4505.1847699866221, 4511.8618534478692, 4518.540195562523,
    4525.2197947483683, 4531.900649427158, 4538.5827580246078, 4545.2661189703731,
    4551.9507306980413, 4558.6365916451105, 4565.3237002529768, 4572.0120549669236,
    4578.7016542361025, 4585.3924965135202, 4592.0845802560279, 4598.7779039242978,
    4605.4724659828189, 4612.1682648998767, 4618.8652991475437, 4625.5635672016597,
    4632.2630675418204, 4638.9637986513681, 4645.6657590173709, 4652.3689471306116,
    4659.0733614855762, 4665.7790005804354, 4672.4858629170385, 4679.1939470008911,
    4685.9032513411494, 4692.6137744506022, 4699.3255148456583, 4706.0384710463359,
    4712.752641576245, 4719.4680249625799, 4726.184619736101, 4732.902424431124,
    4739.6214375855097, 4746.3416577406442, 4753.063083441436, 4759.7857132362915,
    4766.5095456771132, 4773.2345793192799, 4779.9608127216379, 4786.6882444464891,
    4793.4168730595738, 4800.1466971300633, 4806.8777152305456, 4813.6099259370121,
    4820.3433278288494, 4827.0779194888219, 4833.8136995030654, 4840.5506664610675,
    4847.2888189556625, 4854.0281555830197, 4860.7686749426266, 4867.5103756372782,
    4874.2532562730703, 4880.9973154593818, 4887.7425518088667, 4894.4889639374387,
    4901.2365504642685, 4907.9853100117607, 4914.7352412055488, 4921.486342674486,
    4928.2386130506275, 4934.9920509692256, 4941.7466550687132, 4948.5024239906979,
    4955.2593563799446, 4962.0174508843729, 4968.7767061550358, 4975.5371208461193,
    4982.2986936149236, 4989.061423121856, 4995.8253080304175, 5002.5903470071989,
    5009.3565387218596, 5016.1238818471247, 5022.8923750587728, 5029.6620170356255,
    5036.4328064595338, 5043.204742015374, 5049.9778223910298, 5056.7520462773873,
    5063.5274123683239, 5070.3039193606955, 5077.0815659543305, 5083.8603508520164,
    5090.6402727594887, 5097.4213303854249, 5104.2035224414312, 5110.9868476420352,
    5117.7713047046727, 5124.5568923496803, 5131.3436093002865, 5138.1314542825958,
    5144.9204260255874, 5151.710523261102, 5158.5017447238279, 5165.294089151299,
    5172.0875552838779, 5178.8821418647549, 5185.6778476399286, 5192.4746713582035,
    5199.2726117711782, 5206.0716676332377, 5212.8718377015384, 5219.6731207360108,
    5226.4755154993354, 5233.2790207569442, 5240.0836352770066, 5246.8893578304223,
    5253.6961871908143, 5260.5041221345155, 5267.3131614405584, 5274.1233038906739,
    5280.9345482692752, 5287.7468933634518, 5294.5603379629629, 5301.3748808602222,
    5308.1905208502976, 5315.0072567308925, 5321.8250873023462, 5328.6440113676217,
    5335.464027732296, 5342.2851352045527, 5349.1073325951729, 5355.9306187175298,
    5362.7549923875713, 5369.5804524238274, 5376.4069976473838, 5383.2346268818865,
    5390.0633389535287, 5396.8931326910415, 5403.7240069256868, 5410.5559604912532,
    5417.3889922240387, 5424.2231009628522, 5431.0582855490002, 5437.8945448262775,
    5444.7318776409629, 5451.5702828418098, 5458.409759280039, 5465.2503058093271,
    5472.0919212858053, 5478.9346045680441, 5485.7783545170496, 5492.6231699962582,
    5499.4690498715217, 5506.3159930111078, 5513.1639982856841, 5520.0130645683166,
    5526.8631907344634, 5533.7143756619562, 5540.5666182310088, 5547.4199173241941,
    5554.2742718264499, 5561.1296806250602, 5567.9861426096541, 5574.8436566721994,
    5581.7022217069907, 5588.5618366106455, 5595.422500282094, 5602.2842116225738,
    5609.1469695356254, 5616.0107729270776, 5622.8756207050492, 5629.7415117799328,
    5636.6084450643948, 5643.4764194733652, 5650.3454339240307, 5657.2154873358286,
    5664.0865786304394, 5670.958706731778, 5677.8318705659904, 5684.7060690614435,
    5691.5813011487207, 5698.457565760611, 5705.3348618321097, 5712.2131883004004,
    5719.0925441048612, 5725.9729281870459, 5732.8543394906901, 5739.7367769616867,
    5746.6202395480996, 5753.5047262001435, 5760.390235870178, 5767.2767675127079,
    5774.1643200843737, 5781.0528925439376, 5787.9424838522928, 5794.8330929724398,
    5801.7247188694919, 5808.6173605106642, 5815.5110168652673, 5822.4056869047008,
    5829.3013696024491, 5836.1980639340709, 5843.0957688772005, 5849.9944834115295,
    5856.8942065188148, 5863.7949371828599, 5870.6966743895164, 5877.5994171266748,
    5884.5031643842594, 5891.407915154221, 5898.3136684305337, 5905.2204232091808,
    5912.1281784881639, 5919.0369332674791, 5925.9466865491231, 5932.8574373370848,
    5939.7691846373364, 5946.6819274578302, 5953.5956648084903, 5960.5103957012088,
    5967.4261191498399, 5974.3428341701929, 5981.260539780028, 5988.1792349990492,
    5995.0989188488966, 6002.0195903531458, 6008.9412485372968, 6015.8638924287725,
    6022.7875210569109, 6029.7121334529593, 6036.6377286500701, 6043.5643056832914,
    6050.491863589571, 6057.420401407735, 6064.3499181784982, 6071.2804129444503
};

constexpr size_t log_factorial_size = sizeof(log_factorial) / sizeof(double);

/*
 * a11 | a12
 * ----|----
 * a21 | a22
 *
 */

double dng::stats::fisher_exact_test(int a11, int a12, int a21, int a22) {
    const int row1 = a11 + a12;
    const int row2 = a21 + a22;
    const int col1 = a11 + a21;
    const int col2 = a12 + a22;
    const int N = row1 + row2;
    if(N >= 512) {
        return g_test(a11, a12, a21, a22);
    }

    double scale = log_factorial[row1] + log_factorial[row2]
                   + log_factorial[col1] + log_factorial[col2] - log_factorial[N];

    double cutoff = log_factorial[a11] + log_factorial[a12]
                    + log_factorial[a21] + log_factorial[a22];

    double value = exp(scale - cutoff);
    int b11 = a11, b12 = a12, b21 = a21, b22 = a22;
    while(b11 > 0 && b22 > 0) {
        b11--; b12++;
        b21++; b22--;
        double p = log_factorial[b11] + log_factorial[b12]
                   + log_factorial[b21] + log_factorial[b22];
        if(p > cutoff) {
            value += exp(scale - p);
        }
    }
    b11 = a11, b12 = a12, b21 = a21, b22 = a22;
    while(b12 > 0 && b21 > 0) {
        b11++; b12--;
        b21--; b22++;
        double p = log_factorial[b11] + log_factorial[b12]
                   + log_factorial[b21] + log_factorial[b22];
        if(p > cutoff) {
            value += exp(scale - p);
        }
    }
    return (value <= 1.0) ? value : 1.0;
}

inline double xlogx(double x) {
    return (x == 0.0) ? 0.0 : x * log(x);
}

double dng::stats::g_test(double a11, double a12, double a21, double a22) {
    using boost::math::chi_squared;
    using boost::math::complement;
    using boost::math::cdf;

    double row1 = a11 + a12, row2 = a21 + a22;
    double col1 = a11 + a21, col2 = a12 + a22;
    double N = row1 + row2;

    double value = xlogx(a11 / N) + xlogx(a12 / N) + xlogx(a21 / N) + xlogx(
                       a22 / N);
    value -= xlogx(row1 / N) + xlogx(row2 / N) + xlogx(col1 / N) + xlogx(col2 / N);
    value *= 2.0 * N;

    return cdf(complement(chi_squared{1}, value));
}

double dng::stats::ad_two_sample_test(std::vector<uint8_t> a,
                                      std::vector<uint8_t> b) {
    using namespace std;
    using namespace boost;

    sort(a);
    sort(b);
    vector<uint8_t> Z(a.size() + b.size());
    merge(a, b, Z.begin());

    auto ait = a.begin();
    auto bit = b.begin();
    double A2 = 0.0, Ma = 0.0, Mb = 0.0;
    double na = a.size(), nb = b.size();
    double N = na + nb;

    double H = 1.0 / na + 1.0 / nb;
    double h = 0.0, g = 0.0;

    for(size_t i = 1; i < Z.size(); ++i) {
        h += 1.0 / i;
        for(size_t j = i + 1; j < Z.size(); ++j) {
            g += 1.0 / ((N - i) * j);
        }
    }

    double ca = (4.0 * g - 6.0) * 1.0 + (10.0 - 6.0 * g) * H;
    double cb = (2.0 * g - 4.0) * 2.0 * 2.0 + 8.0 * h * 2.0 +
                (2.0 * g - 14.0 * h - 4.0) * H - 8.0 * h + 4.0 * g - 6.0;
    double cc = (6.0 * h + 2.0 * g - 2.0) * 2.0 * 2.0 + (4.0 * h - 4.0 * g + 6.0) *
                2.0 + (2.0 * h - 6.0) * H + 4.0 * h;
    double cd = (2.0 * h + 6.0) * 2.0 * 2.0 - 4.0 * h * 2.0;

    // As N->Infinity, var -> 2.0*(M_PI*M_PI-9.0)/3.0
    double var = (((ca * N + cb) * N + cc) * N + cd) / ((N - 1.0) * (N - 2.0) *
                 (N - 3.0));

    // Check for degenerate sample
    auto zit = adjacent_find(Z, std::not_equal_to<uint8_t> {});
    if(zit == Z.end()) {
        return -1.0 / sqrt(var);
    }

    for(; zit != Z.end(); ++zit) {
        auto next = zit;
        while(++next != Z.end()) {
            if(*zit != *next) {
                break;
            }
            zit = next;
        }

        size_t fa = 0, fb = 0;
        for(; ait != a.end() && *ait == *zit; ++ait, ++fa)
            /*noop*/;
        for(; bit != b.end() && *bit == *zit; ++bit, ++fb)
            /*noop*/;
        Ma += 0.5 * fa;
        Mb += 0.5 * fb;
        double B = Ma + Mb;
        double l = fa + fb;
        double a2 = (N * Ma - na * B) * (N * Ma - na * B) / na + (N * Mb - nb * B) *
                    (N * Mb - nb * B) / nb;
        a2 *= l / (B * (N - B) - N * l / 4.0);
        A2 += a2;

        Ma += 0.5 * fa;
        Mb += 0.5 * fb;
    }

    A2 *= (N - 1.0) / N / N;

    return (A2 - 1.0) / sqrt(var);
}
