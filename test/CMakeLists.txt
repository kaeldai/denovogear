FIND_PACKAGE(Boost COMPONENTS unit_test_framework REQUIRED)
FIND_PACKAGE(HTSLIB)

################################################################################
# Determine the location of the executables/scripts and any data sets required for full package testing
# TODO: Search for packages and data installed outside of denovogear directory, move to ../modules/
SET(DNG_CALL_EXE ${CMAKE_BINARY_DIR}/src/dng-call)
IF(NOT TEST_DATA_DIR)
  IF(IS_DIRECTORY ${CMAKE_SOURCE_DIR}/testdata)
    SET(TEST_DATA_DIR ${CMAKE_SOURCE_DIR}/testdata)
  ELSEIF(IS_DIRECTORY ${CMAKE_SOURCE_DIR}/../testdata)
    SET(TEST_DATA_DIR ${CMAKE_SOURCE_DIR}/../testdata)
  ELSE(NOT TEST_DATA_DIR)
    MESSAGE("Unable to find data for full package testing. Please set TEST_DATA_DIR")
  ENDIF(IS_DIRECTORY ${CMAKE_SOURCE_DIR}/testdata)
ENDIF(NOT TEST_DATA_DIR)

SET(DNG_DNM_EXE ${CMAKE_BINARY_DIR}/src/dng-dnm)

################################################################################
# Compile unit tests
include_directories(../src/include)
include_directories(${Boost_INCLUDE_DIRS})
include_directories(${EIGEN3_INCLUDE_DIR})
include_directories(${EIGEN3_INCLUDE_DIR}/unsupported)
add_definitions(-DBOOST_TEST_DYN_LINK)

# Make a test for each unit test file located in test/ dir
file(GLOB_RECURSE TESTS test_*[cc|cpp])
foreach(test ${TESTS})
  get_filename_component(testName ${test} NAME_WE)
  add_executable(${testName} ${test})
  set_target_properties(${testName} PROPERTIES CXX_STANDARD 11)
  set_target_properties(${testName} PROPERTIES CXX_STANDARD_REQUIRED ON)
  target_link_libraries(${testName} ${Boost_LIBRARIES} ${HTSLIB_LIBRARIES})
  add_test(${testName} ${testName})
endforeach(test)

################################################################################
# Full executable tests
IF(NOT IS_DIRECTORY "${TEST_DATA_DIR}")
  MESSAGE("Could not find directory ${TEST_DATA_DIR}. Full Package tests will fail")
ENDIF()
    
ADD_TEST(Test_Help ${DNG_CALL_EXE})
SET_TESTS_PROPERTIES(Test_Help PROPERTIES PASS_REGULAR_EXPRESSION "Usage:")

ADD_TEST(FullTest_Sample5.3_BAM ${DNG_CALL_EXE} -f ${TEST_DATA_DIR}/sample_5_3/sample-5.3_ref.fasta.gz -p ${TEST_DATA_DIR}/sample_5_3/ceu.ped -m 0.001 ${TEST_DATA_DIR}/sample_5_3/test1.bam)
SET_TESTS_PROPERTIES(FullTest_Sample5.3_BAM PROPERTIES PASS_REGULAR_EXPRESSION "^.*(126385924)")

ADD_TEST(FullTest_Sample5.3_VCF ${DNG_CALL_EXE} -p ${TEST_DATA_DIR}/sample_5_3/ceu.ped -m 0.001 ${TEST_DATA_DIR}/sample_5_3/test1.vcf)
SET_TESTS_PROPERTIES(FullTest_Sample5.3_VCF PROPERTIES 
  PASS_REGULAR_EXPRESSION "LL=-74\.68" 
  PASS_REGULAR_EXPRESSION "25,29,1"
  PASS_REGULAR_EXPRESSION "57,0,0"
  PASS_REGULAR_EXPRESSION "76,1,0")


ADD_TEST(FullTest_SampleCEU_DNM ${DNG_DNM_EXE} auto --ped ${TEST_DATA_DIR}/sample_CEU/sample_CEU.ped --bcf ${TEST_DATA_DIR}/sample_CEU/sample_CEU.bcf --snp_mrate 2e-10 --indel_mrate 1e-11)
SET_TESTS_PROPERTIES(FullTest_SampleCEU_DNM PROPERTIES
  PASS_REGULAR_EXPRESSION "First mrate: 1 last: 1"
  PASS_REGULAR_EXPRESSION "First code: 6 last: 6"
  PASS_REGULAR_EXPRESSION "First tref: 0\.0002388 last: 0\.99301"
  PASS_REGULAR_EXPRESSION "First prior: 0\.05 last: 0\.114"
  PASS_REGULAR_EXPRESSION "Total number of SNP sites interrogated: 36"
  PASS_REGULAR_EXPRESSION "Total number of SNP sites passing read-depth filters: 36")
#DENOVO-SNP CHILD_ID: NA12878_vald-sorted.bam.bam chr: 2 pos: 214668360 ref: G alt: A maxlike_null: 3.95324e-12 pp_null: 0.0195898 tgt_null(child/mom/dad): GG/GG/GG snpcode: 1 code: 6 maxlike_dnm: 1.98602e-10 pp_dnm: 0.98041 tgt_dnm(child/mom/dad): AG/GG/GG lookup: 4 flag: 0 READ_DEPTH child: 48 dad: 76 mom: 34 MAPPING_QUALITY child: 59 dad: 59 mom: 59



